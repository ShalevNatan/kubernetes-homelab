---
# Stage 3, Phase 3: Install Kubernetes packages
# Purpose: Install kubeadm, kubelet, kubectl, and cri-tools
# Duration: ~3 minutes execution time
# Prerequisites: Phase 2 complete (containerd installed and running)
# Idempotent: Safe to re-run multiple times

- name: Install Kubernetes packages on all nodes
  hosts: all
  become: true
  vars:
    # Kubernetes version pinning (1.34.3 from ADR-010)
    kubernetes_version: "1.34"
    kubernetes_minor_version: "1.34.3"
    # Package versions in Kubernetes APT repo format
    kubernetes_package_version: "1.34.3-1.1"
    
    # Kubernetes APT repository configuration
    kubernetes_gpg_key_url: "https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key"
    kubernetes_apt_repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /"

  tasks:
    # ============================================================================
    # TASK GROUP 1: Kubernetes APT Repository Setup
    # Why: Ubuntu repos don't have Kubernetes packages, must use official K8s repo
    # ============================================================================

    - name: Create directory for Kubernetes APT keyring
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      # What this does: Ensures /etc/apt/keyrings/ exists
      # Why: Modern Debian/Ubuntu standard for APT signing keys
      # Note: Already exists from Phase 2 (containerd), but we ensure it (idempotency)

    - name: Download and install Kubernetes GPG key
      ansible.builtin.shell: |
        curl -fsSL {{ kubernetes_gpg_key_url }} | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      # What this does: Downloads K8s signing key and converts to binary keyring format
      # Why dearmor: APT requires GPG keys in binary format (not ASCII-armored)
      # URL structure: https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key
      # Idempotency: creates: ensures we don't re-download if key exists
      # Security: GPG key verifies package authenticity (MITM protection)

    - name: Add Kubernetes APT repository
      ansible.builtin.apt_repository:
        repo: "{{ kubernetes_apt_repo }}"
        state: present
        filename: kubernetes
        update_cache: yes
      # What this does: Adds K8s repo to /etc/apt/sources.list.d/kubernetes.list
      # Why: Enables apt to find kubeadm, kubelet, kubectl packages
      # Version-specific: v1.34 repo only has 1.34.x packages (prevents accidental upgrades)
      # update_cache: Runs apt-get update automatically after adding repo

    # ============================================================================
    # TASK GROUP 2: Package Installation
    # Why: Kubernetes requires these 4 packages for cluster operation
    # ============================================================================

    - name: Install Kubernetes packages
      ansible.builtin.apt:
        name:
          - "kubelet={{ kubernetes_package_version }}"
          - "kubeadm={{ kubernetes_package_version }}"
          - "kubectl={{ kubernetes_package_version }}"
          - "cri-tools"
        state: present
      # What this does: Installs 4 packages at specific versions
      # 
      # Package breakdown:
      # 1. kubelet (1.34.3-1.1):
      #    - Node agent that runs on every cluster node
      #    - Manages pod lifecycle (start, stop, monitor containers)
      #    - Communicates with API server to receive pod specs
      #    - Talks to containerd via CRI socket
      #    - Registers node with cluster
      #
      # 2. kubeadm (1.34.3-1.1):
      #    - Cluster bootstrap tool (used once during setup)
      #    - Commands: init (control plane), join (workers), upgrade
      #    - Generates certificates, configures control plane
      #    - Not used after cluster is running (unlike kubelet)
      #
      # 3. kubectl (1.34.3-1.1):
      #    - CLI tool for cluster management
      #    - Runs kubectl commands (get, apply, delete, logs, etc.)
      #    - Communicates with API server via kubeconfig
      #    - Installed on all nodes for troubleshooting
      #    - Primary usage will be from WSL2 (we'll configure later)
      #
      # 4. cri-tools (latest compatible version):
      #    - Provides crictl CLI tool (CRI debugging)
      #    - Not version-pinned (compatible with all K8s 1.34.x)
      #    - Used for troubleshooting container runtime issues
      #    - Commands: crictl ps, crictl logs, crictl exec
      #
      # Version format explanation:
      #   1.34.3-1.1
      #   ^^^^^^ ^^^
      #   K8s    Package revision (Debian packaging version)
      #   version

    - name: Hold Kubernetes packages at current version
      ansible.builtin.dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl
      # What this does: Prevents apt upgrade from updating these packages
      # Why: Kubernetes upgrades must be deliberate (control plane â†’ workers)
      # Uncontrolled upgrades break clusters (version skew policy violations)
      # Release: Stage 7 (cluster upgrade exercise)
      # Note: cri-tools NOT held (can upgrade independently)

    # ============================================================================
    # TASK GROUP 3: kubelet Service Configuration
    # Why: kubelet must be enabled (but not started yet - no config exists)
    # ============================================================================

    - name: Enable kubelet service
      ansible.builtin.systemd:
        name: kubelet
        enabled: yes
      # What this does: Creates systemd symlink to start kubelet at boot
      # Why enabled but not started:
      #   - kubelet requires config file (/var/lib/kubelet/config.yaml)
      #   - Config is created by kubeadm init (Phase 4) or kubeadm join (Phase 6)
      #   - Starting now would fail with "config file not found"
      # Service status after this task: enabled, inactive (dead)
      # Will auto-start after kubeadm init/join creates config

    # ============================================================================
    # TASK GROUP 4: Verification
    # Purpose: Confirm all packages installed correctly before Phase 4
    # ============================================================================

    - name: Verify kubeadm version
      ansible.builtin.command: kubeadm version -o short
      register: kubeadm_version
      changed_when: false
      # What this does: Checks kubeadm is installed and reports version
      # Expected output: v1.34.3

    - name: Verify kubelet version
      ansible.builtin.command: kubelet --version
      register: kubelet_version
      changed_when: false
      # What this does: Checks kubelet is installed and reports version
      # Expected output: Kubernetes v1.34.3

    - name: Verify kubectl version
      ansible.builtin.command: kubectl version --client -o yaml
      register: kubectl_version
      changed_when: false
      # What this does: Checks kubectl is installed (client-only, no server yet)
      # Expected output: clientVersion.gitVersion: v1.34.3

    - name: Verify crictl version
      ansible.builtin.command: crictl --version
      register: crictl_version
      changed_when: false
      # What this does: Checks crictl is installed
      # Expected output: crictl version vX.XX.X

    - name: Verify packages are held
      ansible.builtin.command: apt-mark showhold
      register: held_packages
      changed_when: false
      # What this does: Lists all packages held from upgrade
      # Expected output should include: kubelet, kubeadm, kubectl

    - name: Check kubelet service status (should be enabled but inactive)
      ansible.builtin.command: systemctl is-enabled kubelet
      register: kubelet_enabled
      changed_when: false
      failed_when: kubelet_enabled.stdout != "enabled"
      # What this does: Confirms kubelet will start on boot
      # Expected: "enabled" (not "active" - that comes after kubeadm init/join)

    - name: Test CRI connectivity now that crictl is available
      ansible.builtin.command: crictl --runtime-endpoint unix:///run/containerd/containerd.sock version
      register: cri_test
      changed_when: false
      # What this does: Tests that crictl can talk to containerd CRI socket
      # This validates Phase 2 (containerd) is properly accessible
      # Expected output: RuntimeName: containerd, RuntimeVersion: 1.7.29

    - name: Display installation summary
      ansible.builtin.debug:
        msg:
          - "============================================"
          - "Kubernetes Package Installation Complete"
          - "============================================"
          - "kubeadm version: {{ kubeadm_version.stdout }}"
          - "kubelet version: {{ kubelet_version.stdout }}"
          - "kubectl version: {{ kubectl_version.stdout_lines[0] | regex_search('gitVersion: (.+)', '\\1') | first }}"
          - "crictl version: {{ crictl_version.stdout }}"
          - "Held packages: {{ held_packages.stdout_lines | select('search', 'kube') | list | join(', ') }}"
          - "kubelet service: Enabled (will start after kubeadm init/join)"
          - "CRI connectivity: {{ 'OK' if cri_test.rc == 0 else 'FAILED' }}"
          - "Node ready for control plane initialization (Phase 4)"
          - "============================================"
      # What this does: Human-readable summary with version confirmation
      # Portfolio value: Shows systematic verification approach